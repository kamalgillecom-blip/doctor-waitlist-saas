{% extends "base.html" %}

{% block title %}Calendar - Reception{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/dashboard.css">
<style>
    /* Calendar specific styles */
    .calendar-layout {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 100px);
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        padding: var(--space-lg);
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-lg);
    }

    .view-selector {
        display: flex;
        background: var(--color-bg);
        border-radius: var(--radius-md);
        padding: 4px;
    }

    .view-btn {
        padding: 8px 16px;
        border: none;
        background: none;
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-weight: 500;
        color: var(--color-text-secondary);
    }

    .view-btn.active {
        background: white;
        color: var(--color-primary);
        box-shadow: var(--shadow-sm);
    }

    /* Month View Grid */
    .month-grid {
        flex: 1;
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        grid-template-rows: 40px repeat(5, 1fr);
        gap: 1px;
        background: var(--color-border);
        border: 1px solid var(--color-border);
    }

    /* Day View (Hourly) */
    .calendar-grid {
        flex: 1;
        display: grid;
        grid-template-columns: 60px 1fr;
        grid-auto-rows: 120px;
        /* 1 hour slots - larger (2px/min) to fit status lights */
        gap: 1px;
        background: var(--color-border);
        overflow-y: auto;
    }

    .calendar-day-header {
        background: var(--color-bg);
        padding: var(--space-sm);
        text-align: center;
        font-weight: 600;
        font-size: var(--font-size-sm);
    }

    .calendar-day-cell {
        background: white;
        padding: var(--space-sm);
        position: relative;
        min-height: 100px;
    }

    .calendar-day-cell.today {
        background: rgba(59, 130, 246, 0.05);
    }

    .day-number {
        position: absolute;
        top: 5px;
        right: 8px;
        font-size: 0.85rem;
        color: var(--color-text-tertiary);
    }

    .appointment-badge {
        display: block;
        background: var(--color-primary-light);
        color: var(--color-primary-dark);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.75rem;
        margin-bottom: 2px;
        cursor: pointer;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .time-slot-label {
        background: white;
        padding: 8px;
        text-align: right;
        font-size: 0.75rem;
        color: var(--color-text-tertiary);
        border-right: 1px solid var(--color-border);
    }

    .time-slot {
        background: white;
        border-bottom: 1px solid var(--color-border);
        position: relative;
        cursor: pointer;
    }

    .time-slot:hover {
        background: var(--color-bg);
    }

    .appt-block {
        position: absolute;
        left: 2px;
        right: 2px;
        padding: 4px;
        background: var(--color-primary-light);
        color: var(--color-primary-dark);
        border-left: 3px solid var(--color-primary);
        border-radius: 4px;
        font-size: 0.8rem;
        z-index: 10;
        overflow: visible;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div style="display: flex;">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-nav">
            <a href="/dashboard" class="sidebar-item" title="Dashboard">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                </svg>
            </a>
            <a href="/messages" class="sidebar-item" title="Messages">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z" />
                </svg>
            </a>
            <a href="/calendar" class="sidebar-item active" title="Calendar">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM9 10H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z" />
                </svg>
            </a>
            <a href="/customers" class="sidebar-item" title="Customers">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                </svg>
            </a>
            <a href="/settings" class="sidebar-item" title="Settings">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
                </svg>
            </a>
            <a href="#" class="sidebar-item" onclick="alert('Analytics page coming soon!'); return false;"
                title="Analytics">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z" />
                </svg>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div style="flex: 1; padding: var(--space-xl); overflow-y: auto; margin-left: var(--sidebar-width);">
        <div class="calendar-layout">
            <div class="calendar-header">
                <div style="display:flex; align-items:center; gap: 20px;">
                    <div>
                        <h2>Calendar</h2>
                        <h4 id="currentDateDisplay" class="text-muted" style="margin-top:0;">Today</h4>
                    </div>

                    <!-- Doctor Filter -->
                    <select id="calendarDoctorFilter" class="form-control" style="width:200px; display:none;"
                        onchange="loadAppointments()">
                        <option value="">All Providers</option>
                    </select>
                </div>

                <div style="display:flex; gap: 10px;">
                    <button class="view-btn" onclick="openGlobalAppointmentModal()">+ New Appointment</button>
                    <div class="view-selector">
                        <button class="view-btn" onclick="setView('month')" id="btn-month">Month</button>
                        <button class="view-btn" onclick="setView('week')" id="btn-week">Week</button>
                        <button class="view-btn active" onclick="setView('day')" id="btn-day">Day</button>
                    </div>
                </div>
            </div>

            <!-- Views Container -->
            <div id="calendarContainer" style="flex: 1; display:flex; flex-direction:column; overflow:hidden;">
                <!-- Content rendered by JS -->
            </div>
        </div>
    </div>
</div>

<!-- Appointment Detail Modal -->
<div id="apptDetailModal" class="modal-overlay" style="display: none;">
    <div class="modal appt-detail-modal">
        <div class="appt-detail-header">
            <div>
                <h2 id="adm-name">Patient Name</h2>
                <div class="appt-detail-time" id="adm-time">Date & Time</div>
            </div>
            <button class="close-btn" onclick="closeApptDetailModal()">&times;</button>
        </div>

        <div class="appt-detail-actions">
            <a id="adm-call-btn" href="tel:" class="btn btn-secondary">
                ðŸ“ž Call
            </a>
            <button class="btn btn-secondary" onclick="sendSmsToPatient()">
                ðŸ’¬ SMS
            </button>
            <button class="btn btn-primary" onclick="checkInFromModal()">
                âœ“ Check In
            </button>
            <button class="btn btn-success" onclick="addToWaitlistFromModal()">
                + Add to Waitlist
            </button>
        </div>

        <div class="appt-detail-tabs">
            <button class="appt-tab-btn active" onclick="switchApptTab('details')">Details</button>
            <button class="appt-tab-btn" onclick="switchApptTab('messages')">Messages</button>
            <button class="appt-tab-btn" onclick="switchApptTab('documents')">Documents</button>
        </div>

        <div class="appt-detail-content">
            <!-- Details Tab -->
            <div id="appt-tab-details" class="appt-tab-content active">
                <h4 style="margin-bottom: 16px;">Status Indicators</h4>
                <div class="appt-status-row">
                    <div class="appt-status-label">
                        <span class="appt-status-indicator yellow" id="adm-confirmed"
                            onclick="toggleApptStatus('confirmed')" title="Patient confirmed appointment"></span>
                        <span>Confirmed</span>
                    </div>
                    <span id="adm-confirmed-text" style="color: #6b7280; font-size: 0.9em;">Not yet</span>
                </div>
                <div class="appt-status-row">
                    <div class="appt-status-label">
                        <span class="appt-status-indicator teal" id="adm-arrived" onclick="toggleApptStatus('arrived')"
                            title="Patient has arrived"></span>
                        <span>Arrived</span>
                    </div>
                    <span id="adm-arrived-text" style="color: #6b7280; font-size: 0.9em;">Not yet</span>
                </div>
                <div class="appt-status-row">
                    <div class="appt-status-label">
                        <span class="appt-status-indicator green" id="adm-checked-in"
                            onclick="toggleApptStatus('checked_in')" title="Checked in to waitlist"></span>
                        <span>Checked In</span>
                    </div>
                    <span id="adm-checked-in-text" style="color: #6b7280; font-size: 0.9em;">Not yet</span>
                </div>
                <div class="appt-status-row">
                    <div class="appt-status-label">
                        <span class="appt-status-indicator purple" id="adm-stepping-out"
                            onclick="toggleApptStatus('stepping_out')"
                            title="Patient stepped out, will be reminded"></span>
                        <span>Stepping Out</span>
                    </div>
                    <span id="adm-stepping-out-text" style="color: #6b7280; font-size: 0.9em;">No</span>
                </div>

                <h4 style="margin: 24px 0 16px;">Appointment Info</h4>
                <div style="background: #f9fafb; padding: 16px; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #6b7280;">Phone</span>
                        <span id="adm-phone" style="font-weight: 600;">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #6b7280;">Service</span>
                        <span id="adm-service" style="font-weight: 600;">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #6b7280;">Notes</span>
                        <span id="adm-notes" style="font-weight: 600;">-</span>
                    </div>
                </div>
            </div>

            <!-- Messages Tab -->
            <div id="appt-tab-messages" class="appt-tab-content">
                <div id="adm-messages-list" style="max-height: 300px; overflow-y: auto;">
                    <p style="color: #6b7280; text-align: center;">No messages</p>
                </div>
                <div style="margin-top: 16px; display: flex; gap: 8px;">
                    <input type="text" id="adm-sms-input" class="form-control" placeholder="Type a message..."
                        style="flex: 1;">
                    <button class="btn btn-primary" onclick="sendQuickSms()">Send</button>
                </div>
            </div>

            <!-- Documents Tab -->
            <div id="appt-tab-documents" class="appt-tab-content">
                <div id="adm-documents-list" style="max-height: 300px; overflow-y: auto;">
                    <p style="color: #6b7280; text-align: center;">Loading documents...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentView = 'day';
    let currentDate = new Date();
    let appointments = [];

    document.addEventListener('DOMContentLoaded', () => {
        loadDoctorsForCalendar();
        loadAppointments();
    });

    // Load Doctors
    function loadDoctorsForCalendar() {
        API.get('/api/doctors').then(res => {
            if (res.success && res.doctors.length > 0) {
                const sel = document.getElementById('calendarDoctorFilter');
                sel.style.display = 'block';
                res.doctors.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.id;
                    opt.textContent = `For: ${d.name}`;
                    sel.appendChild(opt);
                });
            }
        });
    }

    function setView(view) {
        currentView = view;
        document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-${view}`).classList.add('active');
        renderCalendar();
    }

    async function loadAppointments() {
        // Build query params
        // For simplicity fetch all for current range logic
        // Real app would optimize by range e.g. start=X&end=Y
        const res = await API.get('/api/appointments');
        if (res.success) {
            appointments = res.appointments;
            renderCalendar();
        }
    }

    function getFilteredAppointments() {
        const filterId = document.getElementById('calendarDoctorFilter').value;
        if (!filterId) return appointments;
        // Assuming appointment has resource/doctor_id or we filter by logic
        // Current appointment table has 'resource' which is string, 
        // We'll trust backend or simple matching. 
        // For now, let's just return all if filter not implemented strictly in backend schema
        return appointments;
        // Note: Real filtering requires doctor_id on appointment table, which we might not have explicitly added?
        // Let's check schema: id, patient_id, appointment_time, duration_minutes, resource, service
        // We can match 'resource' if we saved doctor entry there.
    }

    function renderCalendar() {
        const container = document.getElementById('calendarContainer');
        const displayDate = document.getElementById('currentDateDisplay');
        const filteredAppts = getFilteredAppointments();

        container.innerHTML = '';

        if (currentView === 'day') {
            displayDate.textContent = currentDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            renderDayView(container, filteredAppts);
        } else if (currentView === 'month') {
            displayDate.textContent = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            renderMonthView(container, filteredAppts);
        } else {
            displayDate.textContent = "Week View (Basic)";
            renderWeekView(container, filteredAppts);
        }
    }

    function renderDayView(container, appts) {
        const grid = document.createElement('div');
        grid.className = 'calendar-grid';

        // Render hours 8 AM to 6 PM
        for (let i = 8; i <= 18; i++) {
            const timeLabel = document.createElement('div');
            timeLabel.className = 'time-slot-label';
            timeLabel.textContent = `${i > 12 ? i - 12 : i} ${i >= 12 ? 'PM' : 'AM'}`;
            grid.appendChild(timeLabel);

            const slot = document.createElement('div');
            slot.className = 'time-slot';
            slot.style.position = 'relative';

            // Add dashed line at :30 mark
            const halfHourLine = document.createElement('div');
            halfHourLine.className = 'half-hour-line';
            halfHourLine.style.cssText = `
                position: absolute;
                top: 50%;
                left: 0;
                right: 0;
                border-top: 1px dashed #cbd5e1;
                pointer-events: none;
                z-index: 1;
            `;
            slot.appendChild(halfHourLine);

            // Two clickable areas: top half (:00) and bottom half (:30)
            const topHalf = document.createElement('div');
            topHalf.style.cssText = 'position: absolute; top: 0; left: 0; right: 0; height: 50%; cursor: pointer; z-index: 0;';
            topHalf.onclick = () => {
                const date = new Date(currentDate);
                date.setHours(i, 0, 0, 0);
                openGlobalAppointmentModal(null, null, date.toISOString().slice(0, 16));
            };
            slot.appendChild(topHalf);

            const bottomHalf = document.createElement('div');
            bottomHalf.style.cssText = 'position: absolute; top: 50%; left: 0; right: 0; height: 50%; cursor: pointer; z-index: 0;';
            bottomHalf.onclick = () => {
                const date = new Date(currentDate);
                date.setHours(i, 30, 0, 0);
                openGlobalAppointmentModal(null, null, date.toISOString().slice(0, 16));
            };
            slot.appendChild(bottomHalf);

            // Find appointments in this hour
            const hourAppts = appts.filter(a => {
                const d = new Date(a.appointment_time);
                return d.getDate() === currentDate.getDate() &&
                    d.getMonth() === currentDate.getMonth() &&
                    d.getHours() === i;
            });

            // Calculate horizontal positions for overlapping appointments
            const apptCount = hourAppts.length;
            const apptWidth = apptCount > 1 ? (100 / apptCount) : 100;

            hourAppts.forEach((a, index) => {
                const el = document.createElement('div');
                el.className = 'appt-block';
                const unreadBadge = a.unread_count > 0
                    ? `<span class="unread-sms-badge" title="Unread SMS">ðŸ’¬</span>`
                    : '';
                el.innerHTML = `
                    <div style="font-weight: 600; display: flex; align-items: center; gap: 4px; font-size: ${apptCount > 2 ? '0.75em' : '1em'};">
                        ${a.first_name} ${a.last_name}
                        ${unreadBadge}
                    </div>
                    <div style="font-size: 0.7em; opacity: 0.8;">${a.service || 'Visit'}</div>
                    ${renderStatusIndicators(a)}
                `;
                const d = new Date(a.appointment_time);
                const minutes = d.getMinutes();
                // Snap to grid: Start at 0 or 30
                const snappedMinutes = Math.floor(minutes / 30) * 30;

                // Snap duration to multiples of 30
                const rawDuration = a.duration_minutes || 30;
                const snappedDuration = Math.ceil(rawDuration / 30) * 30;

                // Position horizontally when multiple appointments
                el.style.position = 'absolute';
                el.style.top = `${snappedMinutes * 2}px`;
                el.style.left = `${index * apptWidth}%`;
                el.style.width = `calc(${apptWidth}% - 1px)`;
                el.style.height = `${snappedDuration * 2}px`;
                el.style.zIndex = '5';

                el.onclick = (e) => {
                    e.stopPropagation();
                    showAppointmentActions(a);
                };
                slot.appendChild(el);
            });

            grid.appendChild(slot);
        }
        container.appendChild(grid);
    }

    function renderMonthView(container, appts) {
        const grid = document.createElement('div');
        grid.className = 'month-grid';

        // Headers
        ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(d => {
            const h = document.createElement('div');
            h.className = 'calendar-day-header';
            h.textContent = d;
            grid.appendChild(h);
        });

        // Days
        // Simple logic for current month
        const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
        const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();

        // Padding
        for (let i = 0; i < firstDay; i++) {
            const empty = document.createElement('div');
            empty.className = 'calendar-day-cell';
            empty.style.background = 'var(--color-bg)';
            grid.appendChild(empty);
        }

        for (let i = 1; i <= daysInMonth; i++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day-cell';
            const num = document.createElement('div');
            num.className = 'day-number';
            num.textContent = i;
            dayCell.appendChild(num);

            // Find appts
            const dayAppts = appts.filter(a => {
                const d = new Date(a.appointment_time);
                return d.getDate() === i && d.getMonth() === currentDate.getMonth();
            });

            dayAppts.forEach(a => {
                const badge = document.createElement('div');
                badge.className = 'appointment-badge';
                badge.textContent = `${new Date(a.appointment_time).getHours()}:00 ${a.first_name}`;
                badge.onclick = () => openGlobalAppointmentModal(a.patient_id, a.first_name);
                dayCell.appendChild(badge);
            });

            grid.appendChild(dayCell);
        }

        container.appendChild(grid);
    }

    function renderWeekView(container, appts) {
        // Calculate start of week (Sunday)
        const startOfWeek = new Date(currentDate);
        startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());

        const displayDate = document.getElementById('currentDateDisplay');
        displayDate.textContent = `Week of ${startOfWeek.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;

        const grid = document.createElement('div');
        grid.className = 'week-grid';

        // CSS for week grid
        grid.style.display = 'grid';
        grid.style.gridTemplateColumns = '50px repeat(7, 1fr)';
        grid.style.flex = '1';
        grid.style.overflowY = 'auto';
        grid.style.border = '1px solid var(--color-border)';

        // Header row
        const headerRow = document.createElement('div');
        headerRow.style.display = 'contents';

        // Empty corner
        const corner = document.createElement('div');
        corner.style.background = 'var(--color-bg)';
        corner.style.borderBottom = '1px solid var(--color-border)';
        corner.style.borderRight = '1px solid var(--color-border)';
        grid.appendChild(corner);

        // Day headers
        for (let d = 0; d < 7; d++) {
            const dayDate = new Date(startOfWeek);
            dayDate.setDate(startOfWeek.getDate() + d);
            const header = document.createElement('div');
            header.style.background = 'var(--color-bg)';
            header.style.borderBottom = '1px solid var(--color-border)';
            header.style.borderRight = '1px solid var(--color-border-light)';
            header.style.textAlign = 'center';
            header.style.padding = '8px';
            header.style.fontWeight = '600';
            header.style.fontSize = '0.85em';
            header.textContent = dayDate.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' });
            if (dayDate.toDateString() === new Date().toDateString()) {
                header.style.background = 'var(--color-primary-light)';
                header.style.color = 'var(--color-primary-dark)';
            }
            grid.appendChild(header);
        }

        // Hour rows
        for (let i = 8; i <= 18; i++) {
            // Time label
            const timeLabel = document.createElement('div');
            timeLabel.textContent = `${i > 12 ? i - 12 : i} ${i >= 12 ? 'PM' : 'AM'}`;
            timeLabel.style.minHeight = '60px';
            timeLabel.style.fontSize = '0.7em';
            timeLabel.style.textAlign = 'right';
            timeLabel.style.padding = '4px';
            timeLabel.style.color = 'var(--color-text-tertiary)';
            timeLabel.style.borderBottom = '1px solid var(--color-border-light)';
            timeLabel.style.borderRight = '1px solid var(--color-border)';
            timeLabel.style.background = 'white';
            grid.appendChild(timeLabel);

            // Day cells for this hour
            for (let d = 0; d < 7; d++) {
                const dayDate = new Date(startOfWeek);
                dayDate.setDate(startOfWeek.getDate() + d);

                const cell = document.createElement('div');
                cell.style.minHeight = '60px';
                cell.style.borderBottom = '1px solid var(--color-border-light)';
                cell.style.borderRight = '1px solid var(--color-border-light)';
                cell.style.padding = '2px';
                cell.style.display = 'flex';
                cell.style.flexWrap = 'wrap';
                cell.style.gap = '2px';
                cell.style.alignContent = 'flex-start';
                cell.style.cursor = 'pointer';
                cell.style.background = 'white';

                cell.onclick = (e) => {
                    if (e.target === cell) {
                        const targetDate = new Date(dayDate);
                        targetDate.setHours(i, 0, 0, 0);
                        openGlobalAppointmentModal(null, null, targetDate.toISOString().slice(0, 16));
                    }
                };

                // Find appointments for this hour and day
                const hourAppts = appts.filter(a => {
                    const ad = new Date(a.appointment_time);
                    return ad.toDateString() === dayDate.toDateString() && ad.getHours() === i;
                });

                // Calculate width based on number of appointments
                const apptWidth = hourAppts.length > 1 ? `calc(${100 / Math.min(hourAppts.length, 3)}% - 2px)` : '100%';

                hourAppts.forEach(a => {
                    const el = document.createElement('div');
                    el.className = 'appt-block';
                    // Override absolute position from CSS class for week view flex layout
                    el.style.position = 'relative';
                    el.style.left = 'auto';
                    el.style.right = 'auto';
                    el.style.top = 'auto';

                    el.style.width = apptWidth;
                    el.style.minHeight = '50px';
                    el.style.fontSize = '0.7em';
                    el.style.lineHeight = '1.2';
                    el.style.margin = '0';
                    el.style.flexShrink = '0';

                    let title = `${a.first_name}`;
                    if (a.status === 'blocked') title = 'Blocked';
                    el.innerHTML = `<strong>${title}</strong><br>${a.service || ''}${renderStatusIndicators(a)}`;

                    if (a.status === 'blocked') {
                        el.style.background = '#e5e7eb';
                        el.style.borderLeftColor = '#6b7280';
                        el.style.color = '#374151';
                    }

                    el.onclick = (e) => {
                        e.stopPropagation();
                        if (a.status !== 'blocked') {
                            showAppointmentActions(a);
                        }
                    };

                    cell.appendChild(el);
                });

                grid.appendChild(cell);
            }
        }

        container.appendChild(grid);
    }

    // ========================================
    // Appointment Detail Modal Functions
    // ========================================

    let currentApptData = null;

    async function showAppointmentActions(appointment) {
        // Open the proper modal instead of prompt
        openApptDetailModal(appointment);
    }

    async function openApptDetailModal(appointment) {
        currentApptData = appointment;

        // Load full appointment details
        const res = await API.get(`/api/appointments/${appointment.id}`);
        if (res.success) {
            currentApptData = { ...appointment, ...res.appointment };
            populateApptDetailModal(res);
        } else {
            // Use basic data if API fails
            populateApptDetailModal({ appointment: appointment, messages: [] });
        }

        document.getElementById('apptDetailModal').style.display = 'flex';
    }

    function populateApptDetailModal(data) {
        const appt = data.appointment;

        // Header
        document.getElementById('adm-name').textContent = `${appt.first_name} ${appt.last_name}`;
        const apptDate = new Date(appt.appointment_time);
        document.getElementById('adm-time').textContent = apptDate.toLocaleString('en-US', {
            weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit'
        });

        // Call button
        const phone = appt.phone || '';
        document.getElementById('adm-call-btn').href = `tel:${phone.replace(/\D/g, '')}`;
        document.getElementById('adm-phone').textContent = phone || '-';

        // Service and notes
        document.getElementById('adm-service').textContent = appt.service || '-';
        document.getElementById('adm-notes').textContent = appt.notes || '-';

        // Status indicators
        updateStatusIndicator('confirmed', appt.confirmed);
        updateStatusIndicator('arrived', appt.arrived);
        updateStatusIndicator('checked_in', appt.checked_in);
        updateStatusIndicator('stepping_out', appt.stepping_out);

        // Messages
        renderApptMessages(data.messages || []);
    }

    function updateStatusIndicator(field, value) {
        const el = document.getElementById(`adm-${field.replace('_', '-')}`);
        const textEl = document.getElementById(`adm-${field.replace('_', '-')}-text`);

        if (value) {
            el.classList.add('active');
            textEl.textContent = 'âœ“ Yes';
            textEl.style.color = '#059669';
        } else {
            el.classList.remove('active');
            textEl.textContent = 'Not yet';
            textEl.style.color = '#6b7280';
        }
    }

    function renderApptMessages(messages) {
        const container = document.getElementById('adm-messages-list');
        if (!messages || messages.length === 0) {
            container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No messages yet</p>';
            return;
        }

        container.innerHTML = messages.map(m => `
            <div style="padding: 8px 12px; margin-bottom: 8px; border-radius: 8px; 
                        background: ${m.direction === 'outbound' ? '#dbeafe' : '#f3f4f6'};
                        ${m.direction === 'outbound' ? 'margin-left: 20px;' : 'margin-right: 20px;'}">
                <div style="font-size: 0.75em; color: #6b7280; margin-bottom: 4px;">
                    ${m.direction === 'outbound' ? 'Sent' : 'Received'} â€¢ ${new Date(m.sent_at).toLocaleString()}
                </div>
                <div>${m.message_text}</div>
            </div>
        `).join('');
    }

    function closeApptDetailModal() {
        document.getElementById('apptDetailModal').style.display = 'none';
        currentApptData = null;
    }

    function switchApptTab(tabName) {
        document.querySelectorAll('.appt-tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.appt-tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector(`button[onclick="switchApptTab('${tabName}')"]`).classList.add('active');
        document.getElementById(`appt-tab-${tabName}`).classList.add('active');
    }

    async function toggleApptStatus(field) {
        if (!currentApptData) return;

        const currentValue = currentApptData[field] || 0;
        const newValue = currentValue ? 0 : 1;

        // Special handling for check_in - also add to waitlist
        if (field === 'checked_in' && newValue) {
            await checkInFromModal();
            return;
        }

        const res = await API.patch(`/api/appointments/${currentApptData.id}/status`, {
            [field]: newValue
        });

        if (res.success) {
            currentApptData[field] = newValue;
            updateStatusIndicator(field, newValue);
            loadAppointments(); // Refresh calendar
        }
    }

    async function checkInFromModal() {
        if (!currentApptData) return;

        const res = await API.post(`/api/appointments/${currentApptData.id}/checkin`);
        if (res.success) {
            currentApptData.checked_in = 1;
            updateStatusIndicator('checked_in', 1);
            alert('Patient checked in and added to waitlist!');
            loadAppointments();
        } else {
            alert('Error: ' + (res.error || 'Failed to check in'));
        }
    }

    async function addToWaitlistFromModal() {
        // Same as check-in for now
        await checkInFromModal();
    }

    function sendSmsToPatient() {
        if (!currentApptData || !currentApptData.phone) {
            alert('No phone number available');
            return;
        }
        switchApptTab('messages');
        document.getElementById('adm-sms-input').focus();
    }

    async function sendQuickSms() {
        if (!currentApptData) return;

        const input = document.getElementById('adm-sms-input');
        const message = input.value.trim();
        if (!message) return;

        // TODO: Implement actual SMS sending
        alert(`SMS would be sent to ${currentApptData.phone}:\n\n${message}`);
        input.value = '';
    }

    // Helper function to render status indicators on appointment blocks
    // All circles are always visible (dim), active ones light up
    function renderStatusIndicators(appointment) {
        return `
            <div class="status-indicators">
                <span class="status-circle confirmed ${appointment.confirmed ? 'active' : ''}" data-tooltip="Confirmed"></span>
                <span class="status-circle arrived ${appointment.arrived ? 'active' : ''}" data-tooltip="Arrived"></span>
                <span class="status-circle checked-in ${appointment.checked_in ? 'active' : ''}" data-tooltip="Checked In"></span>
                <span class="status-circle stepping-out ${appointment.stepping_out ? 'active' : ''}" data-tooltip="Stepping Out"></span>
            </div>
        `;
    }

    async function sendAppointmentReminder(appointment) {
        // Load templates
        const res = await API.get('/api/reminder-templates');
        if (!res.success || res.templates.length === 0) {
            alert('No reminder templates available. Add templates in Settings > Reminders.');
            return;
        }

        const templateNames = res.templates.map((t, i) => `${i + 1}. ${t.name}`).join('\n');
        const choice = prompt(`Select a template:\n\n${templateNames}\n\nEnter number:`);

        if (!choice) return;

        const templateIndex = parseInt(choice) - 1;
        if (templateIndex < 0 || templateIndex >= res.templates.length) {
            alert('Invalid selection');
            return;
        }

        const template = res.templates[templateIndex];

        // Confirm send
        const confirmMsg = `Send "${template.name}" reminder to ${appointment.first_name} ${appointment.last_name}?`;
        if (!confirm(confirmMsg)) return;

        // Send reminder
        const sendRes = await API.post(`/api/appointments/${appointment.id}/send-reminder`, {
            template_id: template.id
        });

        if (sendRes.success) {
            alert('Reminder sent successfully!');
        } else {
            alert('Error: ' + (sendRes.error || 'Failed to send reminder'));
        }
    }

    // Enhanced Tab Switching for Documents
    window.switchApptTab = function (tab) {
        document.querySelectorAll('.appt-tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.appt-tab-content').forEach(c => c.classList.remove('active'));

        const btns = document.querySelectorAll('.appt-tab-btn');
        if (tab === 'details') btns[0].classList.add('active');
        if (tab === 'messages') btns[1].classList.add('active');
        if (tab === 'documents') btns[2].classList.add('active');

        const content = document.getElementById(`appt-tab-${tab}`);
        if (content) content.classList.add('active');

        if (tab === 'messages' && window.currentDetailAppt) {
            loadAppointmentMessages(currentDetailAppt.id);
        }
        if (tab === 'documents' && window.currentDetailAppt) {
            loadPatientDocuments(currentDetailAppt.patient_id);
        }
    };

    window.loadPatientDocuments = async function (patientId) {
        const list = document.getElementById('adm-documents-list');
        list.innerHTML = '<p class="text-muted text-center" style="padding:20px;">Loading...</p>';
        if (!patientId) return;

        try {
            const res = await API.get(`/api/patients/${patientId}/submissions`);
            if (res.success && res.submissions.length > 0) {
                list.innerHTML = res.submissions.map(sub => `
                    <div style="background:white; border:1px solid #e5e7eb; border-radius:8px; padding:12px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:600; color:#1f2937;">${sub.form_title}</div>
                            <div style="font-size:0.85em; color:#6b7280;">${new Date(sub.submitted_at).toLocaleString()}</div>
                        </div>
                        <a href="${sub.pdf_path}" target="_blank" class="btn btn-sm btn-outline">View PDF</a>
                    </div>
                `).join('');
            } else {
                list.innerHTML = '<p class="text-muted text-center" style="padding:20px;">No signed documents found.</p>';
            }
        } catch (e) {
            console.error(e);
            list.innerHTML = '<p class="text-danger text-center">Error loading documents.</p>';
        }
    };

</script>
{% endblock %}