{% extends "base.html" %}

{% block title %}Messages - Reception{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/dashboard.css">
<style>
    /* Messages specific styles */
    .messages-layout {
        display: flex;
        height: calc(100vh - 100px);
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        overflow: hidden;
    }

    .messages-list {
        width: 350px;
        border-right: 1px solid var(--color-border);
        display: flex;
        flex-direction: column;
    }

    .messages-header {
        padding: var(--space-md);
        border-bottom: 1px solid var(--color-border);
        background: var(--color-bg);
    }

    .search-bar {
        width: 100%;
        padding: var(--space-sm) var(--space-md);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-full);
        background: var(--color-surface);
    }

    .conversation-list {
        flex: 1;
        overflow-y: auto;
    }

    .conversation-item {
        padding: var(--space-md);
        border-bottom: 1px solid var(--color-border-light);
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .conversation-item:hover {
        background: var(--color-bg);
    }

    .conversation-item.active {
        background: var(--color-primary-light);
        border-left: 3px solid var(--color-primary);
    }

    .conversation-item.unread {
        font-weight: 600;
        background: rgba(var(--color-primary-rgb), 0.05);
    }

    .conversation-name {
        font-size: var(--font-size-base);
        margin-bottom: var(--space-xs);
        display: flex;
        justify-content: space-between;
    }

    .conversation-time {
        font-size: var(--font-size-xs);
        color: var(--color-text-tertiary);
        font-weight: normal;
    }

    .conversation-preview {
        font-size: var(--font-size-sm);
        color: var(--color-text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: white;
    }

    .chat-header {
        padding: var(--space-md);
        border-bottom: 1px solid var(--color-border);
        background: var(--color-surface);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .chat-header-info h3 {
        margin: 0;
        font-size: var(--font-size-lg);
    }

    .chat-header-info span {
        color: var(--color-text-secondary);
        font-size: var(--font-size-sm);
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: var(--space-lg);
        display: flex;
        flex-direction: column-reverse;
        /* Scroll from bottom */
        gap: var(--space-md);
        background: var(--color-bg);
    }

    .message-bubble {
        max-width: 70%;
        padding: var(--space-md);
        border-radius: var(--radius-lg);
        position: relative;
        word-wrap: break-word;
    }

    .message-bubble.outbound {
        align-self: flex-end;
        background: var(--color-primary);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message-bubble.inbound {
        align-self: flex-start;
        background: white;
        border: 1px solid var(--color-border);
        border-bottom-left-radius: 4px;
    }

    .message-time {
        font-size: 0.7rem;
        margin-top: var(--space-xs);
        opacity: 0.7;
        text-align: right;
    }

    .chat-input-area {
        padding: var(--space-md);
        border-top: 1px solid var(--color-border);
        background: var(--color-surface);
        display: flex;
        gap: var(--space-md);
    }

    .chat-input {
        flex: 1;
        padding: var(--space-md);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        resize: none;
        height: 50px;
        font-family: inherit;
    }

    .empty-state {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: var(--color-text-tertiary);
    }

    .unread-badge {
        background: var(--color-danger);
        color: white;
        border-radius: 10px;
        padding: 2px 8px;
        font-size: 0.7rem;
        margin-left: var(--space-sm);
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <!-- Left Sidebar Navigation -->
    <div class="sidebar">
        <div class="sidebar-nav">
            <a href="/dashboard" class="sidebar-item" title="Dashboard">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                </svg>
            </a>
            <a href="/messages" class="sidebar-item active" title="Messages">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z" />
                </svg>
                <span class="sidebar-badge" id="messagesBadge" style="display: none;">0</span>
            </a>
            <a href="/calendar" class="sidebar-item" title="Calendar">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM9 10H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z" />
                </svg>
            </a>
            <a href="/customers" class="sidebar-item" title="Customers">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                </svg>
            </a>
            <a href="/settings" class="sidebar-item" title="Settings">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
                </svg>
            </a>
            <a href="#" class="sidebar-item" onclick="alert('Analytics page coming soon!'); return false;"
                title="Analytics">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z" />
                </svg>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="dashboard-content">
        <div class="dashboard-header" style="margin-bottom: var(--space-lg); padding: var(--space-lg);">
            <h1 class="dashboard-title">Messages</h1>
            <p class="dashboard-subtitle">Communicate with patients via SMS</p>
        </div>

        <div class="messages-layout">
            <!-- Left: Conversation List -->
            <div class="messages-list">
                <div class="messages-header">
                    <input type="text" class="search-bar" placeholder="Search messages..." id="searchMessages">
                </div>
                <div class="conversation-list" id="conversationList">
                    <!-- Loaded via JS -->
                    <div style="padding: 20px; text-align: center;">Loading...</div>
                </div>
            </div>

            <!-- Right: Chat Area -->
            <div class="chat-area" id="chatArea">
                <div class="empty-state">
                    <div style="font-size: 3rem; margin-bottom: 20px;">ðŸ’¬</div>
                    <h3>Select a conversation</h3>
                    <p>Choose a patient from the list to view message history</p>
                </div>
            </div>

            <!-- Hidden Chat Template -->
            <div id="chatTemplate" style="display: none;">
                <div class="chat-header">
                    <div class="chat-header-info">
                        <h3 id="chatPatientName">Patient Name</h3>
                        <span id="chatPatientPhone">123-456-7890</span>
                    </div>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages go here -->
                </div>
                <div class="chat-input-area">
                    <textarea class="chat-input" id="messageInput" placeholder="Type a message..."></textarea>
                    <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPatientId = null;
    let conversations = [];

    document.addEventListener('DOMContentLoaded', () => {
        loadConversations();
        checkUnreadMessagesCount();

        // Refresh conversations every 10 seconds
        setInterval(loadConversations, 10000);
        setInterval(checkUnreadMessagesCount, 15000);
    });

    async function loadConversations() {
        try {
            const result = await API.get('/api/messages/conversations');
            if (result.success) {
                conversations = result.conversations;
                renderConversations();
            }
        } catch (error) {
            console.error('Error loading conversations:', error);
        }
    }

    function renderConversations() {
        const list = document.getElementById('conversationList');
        const filter = document.getElementById('searchMessages').value.toLowerCase();

        const filtered = conversations.filter(c =>
            `${c.first_name} ${c.last_name}`.toLowerCase().includes(filter) ||
            c.phone.includes(filter)
        );

        if (filtered.length === 0) {
            list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--color-text-tertiary);">No conversations found</div>';
            return;
        }

        list.innerHTML = filtered.map(c => `
        <div class="conversation-item ${c.patient_id === currentPatientId ? 'active' : ''} ${c.unread_count > 0 ? 'unread' : ''}" 
             onclick="openChat(${c.patient_id}, '${c.first_name} ${c.last_name}', '${c.phone}')">
            <div class="conversation-name">
                ${c.first_name} ${c.last_name}
                ${c.unread_count > 0 ? `<span class="unread-badge">${c.unread_count}</span>` : ''}
            </div>
            <div class="conversation-time">${formatTimeAgo(c.last_message_time)}</div>
        </div>
    `).join('');
    }

    async function openChat(patientId, name, phone) {
        currentPatientId = patientId;

        // Update active state in list
        renderConversations();

        // Setup chat area
        const chatArea = document.getElementById('chatArea');
        const template = document.getElementById('chatTemplate');

        chatArea.innerHTML = template.innerHTML;
        document.getElementById('chatPatientName').textContent = name;
        document.getElementById('chatPatientPhone').textContent = phone;

        // Load messages
        await loadMessages(patientId);

        // Mark as read
        markAsRead(patientId);
    }

    async function loadMessages(patientId) {
        if (currentPatientId !== patientId) return;

        try {
            const result = await API.get(`/api/messages/patient/${patientId}`);
            if (result.success) {
                renderMessages(result.messages);
            }
        } catch (error) {
            console.error('Error loading messages:', error);
        }
    }

    function renderMessages(messages) {
        const container = document.getElementById('chatMessages');

        if (messages.length === 0) {
            container.innerHTML = '<div style="text-align: center; color: var(--color-text-tertiary);">No messages yet</div>';
            return;
        }

        container.innerHTML = messages.map(m => `
        <div class="message-bubble ${m.direction}">
            ${m.message_text}
            <div class="message-time">${formatTime(m.sent_at)}</div>
        </div>
    `).join('');
    }

    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();

        if (!text || !currentPatientId) return;

        try {
            // Find phone number from active conversation
            const patient = conversations.find(c => c.patient_id === currentPatientId);
            if (!patient) return;

            // We need an API to send a direct message (not just alert)
            // Re-using alert endpoint for now or need new endpoint?
            // Let's assume we use the alert endpoint infrastructure but this is a "chat"
            // Actually, we don't have a direct "send message to patient ID" endpoint that isn't an alert template
            // But we can implement a simple one or use custom logic.
            // For this demo, let's create a temporary solution or assume we added it.
            // Wait, app.py api_send_alert takes an ID and template_id.
            // I should have added a generic send endpoint.
            // Let's implement it in JS via a new hypothetical endpoint or just handle it.
            // I will add a new endpoint for direct messaging in the next backend step if needed.
            // For now, let's log it.

            console.log('Sending message:', text, 'to', currentPatientId);
            input.value = '';

            // Optimistic append
            const container = document.getElementById('chatMessages');
            const now = new Date().toISOString();
            container.innerHTML = `
            <div class="message-bubble outbound">
                ${text}
                <div class="message-time">Just now</div>
            </div>
        ` + container.innerHTML;

            alert('Direct messaging endpoint not implemented yet. Feature coming soon!');

        } catch (error) {
            console.error('Error sending message:', error);
        }
    }

    async function markAsRead(patientId) {
        // Find unread messages for this patient
        // In a real app we'd filter the messages we just loaded
        // For now, let's just trigger a reload of unread counts
        checkUnreadMessagesCount();
    }

    async function checkUnreadMessagesCount() {
        try {
            const result = await API.get('/api/messages/unread-count');
            if (result.success && result.count > 0) {
                const badge = document.getElementById('messagesBadge');
                badge.textContent = result.count;
                badge.style.display = 'flex';
            } else {
                document.getElementById('messagesBadge').style.display = 'none';
            }
        } catch (error) {
            console.error('Error checking messages:', error);
        }
    }

    function formatTimeAgo(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const now = new Date();
        const diff = (now - date) / 1000;

        if (diff < 60) return 'Just now';
        if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
        return date.toLocaleDateString();
    }

    // Add event listener for search
    document.getElementById('searchMessages').addEventListener('input', renderConversations);
</script>
{% endblock %}