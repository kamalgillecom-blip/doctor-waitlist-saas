{% extends "base.html" %}

{% block title %}Customers - Reception{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/dashboard.css">
<style>
    /* Customers specific styles */
    .customers-layout {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        padding: var(--space-lg);
        background: white;
    }

    .table-controls {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--space-lg);
        gap: var(--space-md);
    }

    .search-input {
        flex: 1;
        max-width: 400px;
        padding: var(--space-sm) var(--space-md);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
    }

    .customer-table {
        width: 100%;
        border-collapse: collapse;
    }

    .customer-table th,
    .customer-table td {
        padding: var(--space-md);
        text-align: left;
        border-bottom: 1px solid var(--color-border-light);
    }

    .customer-table th {
        font-weight: 600;
        color: var(--color-text-secondary);
        background: var(--color-bg);
    }

    .customer-table tr:hover {
        background: var(--color-bg);
    }

    .avatar-cell {
        width: 40px;
    }

    .avatar {
        width: 32px;
        height: 32px;
        background: var(--color-primary-light);
        color: var(--color-primary);
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <!-- Left Sidebar Navigation -->
    <div class="sidebar">
        <div class="sidebar-nav">
            <a href="/dashboard" class="sidebar-item" title="Dashboard">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                </svg>
            </a>
            <a href="/messages" class="sidebar-item" title="Messages">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z" />
                </svg>
                <span class="sidebar-badge" id="messagesBadge" style="display: none;">0</span>
            </a>
            <a href="/calendar" class="sidebar-item" title="Calendar">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM9 10H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z" />
                </svg>
            </a>
            <a href="/customers" class="sidebar-item active" title="Customers">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                </svg>
            </a>
            <a href="/settings" class="sidebar-item" title="Settings">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
                </svg>
            </a>
            <a href="#" class="sidebar-item" onclick="alert('Analytics page coming soon!'); return false;"
                title="Analytics">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z" />
                </svg>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="dashboard-content">
        <div class="dashboard-header">
            <h1 class="dashboard-title">Customers</h1>
            <p class="dashboard-subtitle">Manage patient records and history</p>
        </div>

        <div class="customers-layout">
            <div class="table-controls">
                <input type="text" class="search-input" placeholder="Search by name, phone, or email..."
                    id="customerSearch">
                <button class="btn btn-primary" onclick="alert('Add customer feature coming soon!')">
                    + Add Customer
                </button>
            </div>

            <table class="customer-table" id="customerTable">
                <thead>
                    <tr>
                        <th class="avatar-cell"></th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Email</th>
                        <th>Last Visit</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Loading state -->
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px;">Loading patients...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        loadCustomers();
        checkUnreadMessagesCount();
        setInterval(checkUnreadMessagesCount, 15000);
    });

    async function loadCustomers() {
        try {
            const search = document.getElementById('customerSearch').value;
            const res = await API.get(`/api/patients?search=${encodeURIComponent(search)}`);

            const tbody = document.querySelector('#customerTable tbody');

            if (!res.success || !res.patients || res.patients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No customers found.</td></tr>';
                return;
            }

            tbody.innerHTML = res.patients.map(p => {
                const initials = (p.first_name[0] + (p.last_name ? p.last_name[0] : '')).toUpperCase();
                return `
                <tr>
                    <td><div class="avatar">${initials}</div></td>
                    <td>${p.first_name} ${p.last_name}</td>
                    <td>${p.phone || '-'}</td>
                    <td>${p.email || '-'}</td>
                    <td>${formatDate(p.created_at)}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="openPatientModal(${p.id})">Edit</button>
                        <button class="btn btn-sm" onclick="openGlobalAppointmentModal(${p.id}, '${p.first_name} ${p.last_name}')">ðŸ“…</button>
                    </td>
                </tr>
                `;
            }).join('');

        } catch (e) {
            console.error(e);
            document.querySelector('#customerTable tbody').innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">Error loading customers.</td></tr>';
        }
    }

    // Search listener
    document.getElementById('customerSearch').addEventListener('input', debounce(loadCustomers, 500));

    function debounce(func, wait) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    function formatDate(iso) {
        if (!iso) return 'Never';
        return new Date(iso).toLocaleDateString();
    }

    async function checkUnreadMessagesCount() {
        try {
            const result = await API.get('/api/messages/unread-count');
            if (result.success && result.count > 0) {
                const badge = document.getElementById('messagesBadge');
                badge.textContent = result.count;
                badge.style.display = 'flex';
            } else {
                document.getElementById('messagesBadge').style.display = 'none';
            }
        } catch (error) {
            console.error('Error checking messages:', error);
        }
    }
</script>
{% endblock %}