{% extends "base.html" %}

{% block title %}Customers - Reception{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/dashboard.css">
<style>
    /* Customers specific styles */
    .customers-layout {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        padding: var(--space-lg);
        background: white;
    }

    .table-controls {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--space-lg);
        gap: var(--space-md);
    }

    .search-input {
        flex: 1;
        max-width: 400px;
        padding: var(--space-sm) var(--space-md);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
    }

    .customer-table {
        width: 100%;
        border-collapse: collapse;
    }

    .customer-table th,
    .customer-table td {
        padding: var(--space-md);
        text-align: left;
        border-bottom: 1px solid var(--color-border-light);
    }

    .customer-table th {
        font-weight: 600;
        color: var(--color-text-secondary);
        background: var(--color-bg);
    }

    .customer-table tr:hover {
        background: var(--color-bg);
    }

    .avatar-cell {
        width: 40px;
    }

    .avatar {
        width: 32px;
        height: 32px;
        background: var(--color-primary-light);
        color: var(--color-primary);
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <!-- Left Sidebar Navigation -->
    <div class="sidebar">
        <div class="sidebar-nav">
            <a href="/dashboard" class="sidebar-item" title="Dashboard">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                </svg>
            </a>
            <a href="/messages" class="sidebar-item" title="Messages">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z" />
                </svg>
                <span class="sidebar-badge" id="messagesBadge" style="display: none;">0</span>
            </a>
            <a href="/calendar" class="sidebar-item" title="Calendar">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM9 10H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z" />
                </svg>
            </a>
            <a href="/customers" class="sidebar-item active" title="Customers">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                </svg>
            </a>
            <a href="/settings" class="sidebar-item" title="Settings">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
                </svg>
            </a>
            <a href="#" class="sidebar-item" onclick="alert('Analytics page coming soon!'); return false;"
                title="Analytics">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z" />
                </svg>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="dashboard-content">
        <div class="dashboard-header">
            <h1 class="dashboard-title">Customers</h1>
            <p class="dashboard-subtitle">Manage patient records and history</p>
        </div>

        <div class="customers-layout">
            <div class="table-controls">
                <input type="text" class="search-input" placeholder="Search by name, phone, or email..."
                    id="customerSearch">
                <button class="btn btn-primary" onclick="openAddPatientModal()">
                    + Add Customer
                </button>
            </div>

            <table class="customer-table" id="customerTable">
                <thead>
                    <tr>
                        <th class="avatar-cell"></th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Email</th>
                        <th>Last Visit</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Loading state -->
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px;">Loading patients...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Patient Modal -->
<div id="addPatientModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3>Add New Customer</h3>
            <button class="close-modal" onclick="closeAddPatientModal()">Ã—</button>
        </div>

        <div class="modal-tabs">
            <button class="tab-btn active" onclick="switchAddTab('manual')">Manual Entry</button>
            <button class="tab-btn" onclick="switchAddTab('import')">Import CSV</button>
        </div>

        <div class="modal-content">
            <!-- Manual Entry Form -->
            <div id="tab-manual" class="tab-content" style="display: block;">
                <form id="addPatientForm" onsubmit="saveNewPatient(event)">
                    <div class="form-group">
                        <label>First Name *</label>
                        <input type="text" name="first_name" required class="form-control" placeholder="e.g. John">
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" name="last_name" class="form-control" placeholder="e.g. Doe">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone *</label>
                            <input type="tel" name="phone" required class="form-control" placeholder="555-0123">
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <select name="phone_type" class="form-control">
                                <option value="Mobile">Mobile</option>
                                <option value="Home">Home</option>
                                <option value="Work">Work</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="email" class="form-control" placeholder="john@example.com">
                    </div>
                    <div class="form-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" name="tags" class="form-control" placeholder="VIP, Insurance X">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeAddPatientModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Customer</button>
                    </div>
                </form>
            </div>

            <!-- Import CSV Form -->
            <div id="tab-import" class="tab-content" style="display: none;">
                <div class="import-area">
                    <p>Upload a CSV file with headers: <code>first_name, last_name, phone, email, tags</code></p>

                    <div class="file-drop-zone">
                        <input type="file" id="csvFile" accept=".csv" class="file-input">
                        <div class="drop-message">Click to select or drag file here</div>
                    </div>

                    <div class="template-download">
                        <a href="#" onclick="downloadCsvTemplate(event)">Download Template CSV</a>
                    </div>

                    <div id="importStats"
                        style="display: none; margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <!-- Stats will appear here -->
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeAddPatientModal()">Close</button>
                        <button type="button" class="btn btn-primary" onclick="uploadCsv()">Upload & Import</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        loadCustomers();
        checkUnreadMessagesCount();
        setInterval(checkUnreadMessagesCount, 15000);
    });

    async function loadCustomers() {
        try {
            const search = document.getElementById('customerSearch').value;
            const res = await API.get(`/api/patients?search=${encodeURIComponent(search)}`);

            const tbody = document.querySelector('#customerTable tbody');

            if (!res.success || !res.patients || res.patients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">No customers found.</td></tr>';
                return;
            }

            tbody.innerHTML = res.patients.map(p => {
                const initials = (p.first_name[0] + (p.last_name ? p.last_name[0] : '')).toUpperCase();
                return `
                <tr>
                    <td><div class="avatar">${initials}</div></td>
                    <td>${p.first_name} ${p.last_name}</td>
                    <td>${p.phone || '-'}</td>
                    <td>${p.email || '-'}</td>
                    <td>${formatDate(p.created_at)}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="openPatientModal(${p.id})">Edit</button>
                        <button class="btn btn-sm" onclick="openGlobalAppointmentModal(${p.id}, '${p.first_name} ${p.last_name}')">ðŸ“…</button>
                    </td>
                </tr>
                `;
            }).join('');

        } catch (e) {
            console.error(e);
            document.querySelector('#customerTable tbody').innerHTML = '<tr><td colspan="6" style="text-align: center; color: red;">Error loading customers.</td></tr>';
        }
    }

    // Search listener
    document.getElementById('customerSearch').addEventListener('input', debounce(loadCustomers, 500));

    function debounce(func, wait) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    function formatDate(iso) {
        if (!iso) return 'Never';
        return new Date(iso).toLocaleDateString();
    }

    async function checkUnreadMessagesCount() {
        try {
            const result = await API.get('/api/messages/unread-count');
            if (result.success && result.count > 0) {
                const badge = document.getElementById('messagesBadge');
                badge.textContent = result.count;
                badge.style.display = 'flex';
            } else {
                document.getElementById('messagesBadge').style.display = 'none';
            }
        } catch (error) {
            console.error('Error checking messages:', error);
        }
    }

    // --- Add Customer Modal Logic ---

    function openAddPatientModal() {
        document.getElementById('addPatientModal').style.display = 'flex';
        switchAddTab('manual'); // Default to manual
    }

    function closeAddPatientModal() {
        document.getElementById('addPatientModal').style.display = 'none';
        document.getElementById('addPatientForm').reset();
        document.getElementById('importStats').style.display = 'none';
        document.getElementById('csvFile').value = '';
    }

    function switchAddTab(tab) {
        // Toggle Buttons
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active'); // This assumes event is passed implicitly or found

        // Use safer selector logic if event is unreliable:
        const buttons = document.querySelectorAll('.modal-tabs .tab-btn');
        if (tab === 'manual') {
            buttons[0].classList.add('active');
            buttons[1].classList.remove('active');
            document.getElementById('tab-manual').style.display = 'block';
            document.getElementById('tab-import').style.display = 'none';
        } else {
            buttons[0].classList.remove('active');
            buttons[1].classList.add('active');
            document.getElementById('tab-manual').style.display = 'none';
            document.getElementById('tab-import').style.display = 'block';
        }
    }

    async function saveNewPatient(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
            const res = await API.post('/api/patients', data);

            if (res.success) {
                // Success
                closeAddPatientModal();
                loadCustomers(); // Refresh table
                // Optional: Show toast
            } else {
                alert('Error: ' + res.error);
            }
        } catch (err) {
            alert('Error creating customer: ' + err.message);
        }
    }

    function downloadCsvTemplate(e) {
        e.preventDefault();
        const csvContent = "first_name,last_name,phone,email,tags\nJohn,Doe,555-0123,john@example.com,VIP";
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "patient_import_template.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }

    async function uploadCsv() {
        const fileInput = document.getElementById('csvFile');
        const file = fileInput.files[0];
        if (!file) {
            alert("Please select a file first.");
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        try {
            // Need a raw fetch for multipart/form-data usually, 
            // or if API wrapper handles it. My API wrapper sends JSON usually.
            // Let's use fetch directly for file upload to be safe.
            const response = await fetch('/api/patients/import', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                const stats = result.stats;
                const statsDiv = document.getElementById('importStats');
                statsDiv.style.display = 'block';
                statsDiv.innerHTML = `
                    <h4>Import Complete</h4>
                    <p style="color: green">âœ“ Imported: ${stats.imported}</p>
                    <p style="color: orange">âš  Skipped: ${stats.skipped}</p>
                    ${stats.errors.length > 0 ? `<div style="color: red; margin-top: 5px;">Errors:${stats.errors.map(e => `<div>${e}</div>`).join('')}</div>` : ''}
                `;
                loadCustomers(); // Refresh background table
            } else {
                alert('Import Failed: ' + result.error);
            }
        } catch (err) {
            alert('Upload error: ' + err.message);
        }
    }
</script>
{% endblock %}