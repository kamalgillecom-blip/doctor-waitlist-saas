{% extends "base.html" %}

{% block title %}Settings - Doctor Waitlist{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/dashboard.css">
<style>
    .settings-layout {
        display: flex;
        height: calc(100vh - 40px);
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        overflow: hidden;
    }

    .settings-sidebar {
        width: 250px;
        background: #f8f9fa;
        border-right: 1px solid #eee;
        padding: 20px 0;
    }

    .settings-nav-item {
        display: flex;
        align-items: center;
        padding: 12px 24px;
        cursor: pointer;
        color: #555;
        font-weight: 500;
        transition: background 0.2s;
    }

    .settings-nav-item:hover {
        background: #e9ecef;
    }

    .settings-nav-item.active {
        background: #e9ecef;
        color: var(--color-primary);
        border-right: 3px solid var(--color-primary);
    }

    .settings-content {
        flex: 1;
        padding: 40px;
        overflow-y: auto;
    }

    .settings-section {
        display: none;
        max-width: 800px;
    }

    .settings-section.active {
        display: block;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
    }

    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
    }

    .settings-header {
        margin-bottom: 30px;
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
    }

    /* Force Button Visibility (Critical Fix) */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 20px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        font-size: 1rem;
        text-decoration: none;
    }

    .btn-primary {
        background: linear-gradient(135deg, #0f4994 0%, #0a3570 100%) !important;
        color: white !important;
        opacity: 1 !important;
        visibility: visible !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
        color: white !important;
        opacity: 1 !important;
    }

    .btn-outline {
        background: white !important;
        border: 1px solid #ddd !important;
        color: #555 !important;
    }

    .btn-primary:hover,
    .btn-success:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-layout">
    <!-- Left Sidebar Navigation (Main) -->
    <div class="sidebar">
        <div class="sidebar-nav">
            <a href="/dashboard" class="sidebar-item" title="Dashboard">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                </svg>
            </a>
            <a href="/messages" class="sidebar-item" title="Messages">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z" />
                </svg>
            </a>
            <a href="/calendar" class="sidebar-item" title="Calendar">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM9 10H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z" />
                </svg>
            </a>
            <a href="/customers" class="sidebar-item" title="Customers">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                </svg>
            </a>
            <a href="/settings" class="sidebar-item active" title="Settings">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
                </svg>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="dashboard-content">
        <div class="settings-layout">
            <!-- Settings Sidebar -->
            <div class="settings-sidebar">
                <div class="settings-nav-item active" onclick="switchSettingsTab('location')">
                    <span>üìç</span> &nbsp; Location
                </div>
                <div class="settings-nav-item" onclick="switchSettingsTab('doctors')">
                    <span>üë®‚Äç‚öïÔ∏è</span> &nbsp; Doctors & Queues
                </div>
                <div class="settings-nav-item" onclick="switchSettingsTab('schedule')">
                    <span>üïí</span> &nbsp; Schedule
                </div>
                <div class="settings-nav-item" onclick="switchSettingsTab('region')">
                    <span>üåç</span> &nbsp; Region
                </div>
                <div class="settings-nav-item" onclick="switchSettingsTab('display')">
                    <span>üñ•Ô∏è</span> &nbsp; Display
                </div>
                <div class="settings-nav-item" onclick="switchSettingsTab('reminders')">
                    <span>üì±</span> &nbsp; Reminders
                </div>
                <div class="settings-nav-item" onclick="switchSettingsTab('forms')">
                    <span>üìù</span> &nbsp; Patient Forms
                </div>
            </div>

            <!-- Settings Content -->
            <div class="settings-content">
                <!-- Location Settings -->
                <div id="settings-location" class="settings-section active">
                    <div class="settings-header">
                        <h2>Location Details</h2>
                        <p class="text-muted">Manage contact details, address, and more.</p>
                    </div>
                    <form onsubmit="event.preventDefault(); saveSettings('location');">
                        <div class="form-group">
                            <label>Office Name</label>
                            <input type="text" class="form-control" name="office_name" value="Doctor's Office">
                        </div>
                        <div class="form-group">
                            <label>Address</label>
                            <textarea class="form-control" name="address" rows="3">123 Medical Drive</textarea>
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="text" class="form-control" name="phone" value="(555) 123-4567">
                        </div>
                        <div class="form-group">
                            <label>SMS Sender Name (e.g. Dr. Smith)</label>
                            <input type="text" id="officeSmsName" class="form-control"
                                placeholder="Optional - Used in messages">
                        </div>
                        <button class="btn btn-primary">Save Changes</button>
                    </form>
                </div>

                <!-- Doctors Settings -->
                <div id="settings-doctors" class="settings-section">
                    <div class="settings-header">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <h2>Doctors & Queues</h2>
                                <p class="text-muted">Manage providers and their queues.</p>
                            </div>
                            <button class="btn btn-secondary" onclick="addDoctor()">+ Add Doctor</button>
                        </div>
                    </div>
                    <div id="doctorsList">
                        <!-- Populated by JS -->
                        <div class="card p-3 mb-2">
                            <div style="display:flex; justify-content:space-between;">
                                <strong>Dr. Smith (General)</strong>
                                <div>
                                    <button class="btn btn-sm btn-outline">Edit</button>
                                    <button class="btn btn-sm btn-danger">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Schedule Settings -->
                <div id="settings-schedule" class="settings-section">
                    <div class="settings-header">
                        <h2>Schedule</h2>
                        <p class="text-muted">Set weekly hours for each provider.</p>
                    </div>
                    <div id="schedule-matrix-container">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <script>
                    // Add listener to switchSettingsTab to load schedule if tab is 'schedule'
                    const origSwitch = window.switchSettingsTab;
                    window.switchSettingsTab = function (tabId) {
                        origSwitch(tabId);
                        if (tabId === 'schedule') loadScheduleMatrix();
                    }
                </script>

                <!-- Region Settings -->
                <div id="settings-region" class="settings-section">
                    <div class="settings-header">
                        <h2>Region Settings</h2>

                    </div>
                    <div class="form-group">
                        <label>Timezone</label>
                        <select class="form-control">
                            <option>Eastern Time (US & Canada)</option>
                            <option>Pacific Time (US & Canada)</option>
                            <option>UTC</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Currency</label>
                        <select class="form-control">
                            <option>USD ($)</option>
                            <option>EUR (‚Ç¨)</option>
                            <option>GBP (¬£)</option>
                        </select>
                    </div>
                    <button class="btn btn-primary">Save Changes</button>
                </div>

                <!-- Display Settings -->
                <div id="settings-display" class="settings-section">
                    <div class="settings-header">
                        <h2>Display Settings</h2>
                        <p class="text-muted">Customize dashboard themes and external displays.</p>
                    </div>
                    <div class="form-group">
                        <label>Theme Colors (Custom)</label>
                        <div class="grid grid-3">
                            <div>
                                <label style="font-size:0.8em; color:#666;">Primary Color</label>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <input type="color" id="themePrimary" value="#3b82f6"
                                        style="height:40px; width:60px; padding:0; border:none;">
                                    <input type="text" id="themePrimaryText" value="#3b82f6"
                                        style="width:80px; font-size:0.9em;"
                                        onchange="document.getElementById('themePrimary').value = this.value">
                                </div>
                            </div>
                            <div>
                                <label style="font-size:0.8em; color:#666;">Secondary Color</label>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <input type="color" id="themeSecondary" value="#10b981"
                                        style="height:40px; width:60px; padding:0; border:none;">
                                    <input type="text" id="themeSecondaryText" value="#10b981"
                                        style="width:80px; font-size:0.9em;"
                                        onchange="document.getElementById('themeSecondary').value = this.value">
                                </div>
                            </div>
                            <div>
                                <label style="font-size:0.8em; color:#666;">Accent Color</label>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <input type="color" id="themeAccent" value="#f59e0b"
                                        style="height:40px; width:60px; padding:0; border:none;">
                                    <input type="text" id="themeAccentText" value="#f59e0b"
                                        style="width:80px; font-size:0.9em;"
                                        onchange="document.getElementById('themeAccent').value = this.value">
                                </div>
                            </div>
                        </div>
                    </div>

                    <script>
                        // Sync color inputs
                        ['Primary', 'Secondary', 'Accent'].forEach(t => {
                            const picker = document.getElementById('theme' + t);
                            if (picker) {
                                picker.addEventListener('input', (e) => {
                                    document.getElementById('theme' + t + 'Text').value = e.target.value;
                                });
                            }
                        });
                    </script>

                    <button class="btn btn-primary" onclick="saveSettings('display')">Save Changes</button>
                    <!-- <button class="btn btn-primary">Save Changes</button> -->
                </div>

                <!-- Reminders Settings -->
                <div id="settings-reminders" class="settings-section">
                    <div class="settings-header">
                        <h2>Appointment Reminders</h2>
                        <p class="text-muted">Configure automatic SMS reminders for appointments.</p>
                    </div>

                    <!-- Auto-Reminder Settings -->
                    <div class="card p-4 mb-4">
                        <h4 style="margin-top:0;">Auto-Reminders</h4>
                        <div class="form-group">
                            <label style="display:flex; align-items:center; gap:12px; cursor:pointer;">
                                <input type="checkbox" id="autoRemindersEnabled" style="width:18px; height:18px;">
                                <span>Enable automatic appointment reminders</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label>Reminder Timing</label>
                            <div style="display:flex; gap:12px; flex-wrap:wrap;">
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                                    <input type="checkbox" id="remind24hr" checked> 24 hours before
                                </label>
                                <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                                    <input type="checkbox" id="remind2hr"> 2 hours before
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Template Management -->
                    <div class="card p-4">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                            <h4 style="margin:0;">Reminder Templates</h4>
                            <button class="btn btn-sm btn-primary" onclick="openReminderTemplateModal()">+ Add
                                Template</button>
                        </div>
                        <div id="reminderTemplatesList">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <button class="btn btn-primary" style="margin-top:20px;" onclick="saveReminderSettings()">Save
                        Changes</button>
                </div>

                <!-- Reminder Template Modal -->
                <div id="reminderTemplateModal" class="modal-overlay" style="display:none;">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 id="rt-modal-title">Edit Reminder Template</h3>
                            <button class="btn-icon-secondary" onclick="closeReminderTemplateModal()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="rt-id">
                            <div class="form-group">
                                <label>Template Name</label>
                                <input type="text" id="rt-name" class="form-control"
                                    placeholder="e.g. 24 Hour Reminder">
                            </div>
                            <div class="form-group">
                                <label>Reminder Timing</label>
                                <select id="rt-timing" class="form-control">
                                    <option value="15">15 Minutes Before</option>
                                    <option value="30">30 Minutes Before</option>
                                    <option value="60">1 Hour Before</option>
                                    <option value="120">2 Hours Before</option>
                                    <option value="180">3 Hours Before</option>
                                    <option value="240">4 Hours Before</option>
                                    <option value="300">5 Hours Before</option>
                                    <option value="360">6 Hours Before</option>
                                    <option value="420">7 Hours Before</option>
                                    <option value="480">8 Hours Before</option>
                                    <option value="540">9 Hours Before</option>
                                    <option value="600">10 Hours Before</option>
                                    <option value="660">11 Hours Before</option>
                                    <option value="720">12 Hours Before</option>
                                    <option value="1440">24 Hours Before</option>
                                    <option value="2160">36 Hours Before</option>
                                    <option value="2880">48 Hours Before</option>
                                    <option value="4320">72 Hours Before</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Resend if no response (Optional)</label>
                                <select id="rt-resend" class="form-control">
                                    <option value="">-- Do not resend --</option>
                                    <option value="15">After 15 Minutes</option>
                                    <option value="30">After 30 Minutes</option>
                                    <option value="60">After 1 Hour</option>
                                    <option value="120">After 2 Hours</option>
                                </select>
                                <small class="text-muted">Requires active server process.</small>
                            </div>
                            <div class="form-group">
                                <label>Attach Form (Optional)</label>
                                <select id="rt-form" class="form-control">
                                    <option value="">-- No Form Attached --</option>
                                    <!-- Populated via JS -->
                                </select>
                                <small class="text-muted">A link to this form will be appended to the SMS.</small>
                            </div>
                            <div class="form-group">
                                <label>Message Template</label>
                                <textarea id="rt-message" class="form-control" rows="4"
                                    placeholder="Hi {patient_name}..."></textarea>
                                <small class="text-muted">Available: {patient_name}, {appointment_time},
                                    {location_name}, {calendar_link}</small>
                            </div>

                            <div class="form-group"
                                style="background:#f0f9ff; padding:12px; border-radius:6px; border:1px solid #bae6fd; margin-top:15px;">
                                <label
                                    style="color:#0284c7; font-weight:600; font-size:0.85em; display:block; margin-bottom:4px;">SMS
                                    PREVIEW</label>
                                <div id="rt-preview"
                                    style="white-space: pre-wrap; font-family: monospace; font-size:0.9em; color:#334155;">
                                </div>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="closeReminderTemplateModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="saveReminderTemplateForm()">Save Template</button>
                        </div>
                    </div>
                </div>

                <!-- Patient Forms Settings -->
                <div id="settings-forms" class="settings-section">
                    <div class="settings-header">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <h2>Patient Forms</h2>
                                <p class="text-muted">Create and manage intake forms with digital signatures.</p>
                            </div>
                            <button class="btn btn-primary" onclick="showFormBuilder()">+ Create Form</button>
                        </div>
                    </div>

                    <div id="formsList">
                        <!-- Populated by JS -->
                    </div>

                    <!-- Form Builder UI -->
                    <div id="formBuilderUI"
                        style="display:none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                        <h3 style="margin-top:0;">Form Editor</h3>
                        <div class="form-group">
                            <label>Form Title</label>
                            <input type="text" id="fb-title" class="form-control" placeholder="e.g. New Patient Intake">
                        </div>
                        <div class="form-group">
                            <label>Description (Optional)</label>
                            <textarea id="fb-desc" class="form-control" rows="2"
                                placeholder="Instructions for patient..."></textarea>
                        </div>

                        <h4 style="margin: 20px 0 10px;">Questions / Steps</h4>
                        <div id="fb-fields-container" style="margin-bottom: 15px;"></div>

                        <button class="btn btn-sm btn-secondary" onclick="addFormField()">+ Add Question</button>

                        <div
                            style="margin-top: 30px; display:flex; gap: 10px; border-top: 1px solid #eee; padding-top: 20px;">
                            <button class="btn btn-success" onclick="saveCurrentForm()">Save Form</button>
                            <button class="btn btn-outline" onclick="closeFormBuilder()">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Critical Navigation Logic - Isolated for stability
    function switchSettingsTab(tabId) {
        console.log('Switching to tab:', tabId);

        // Update Nav
        document.querySelectorAll('.settings-nav-item').forEach(el => {
            el.classList.remove('active');
            const attr = el.getAttribute('onclick');
            if (attr && attr.includes("'" + tabId + "'")) {
                el.classList.add('active');
            }
        });

        // Update Sections
        document.querySelectorAll('.settings-section').forEach(el => el.classList.remove('active'));
        const sec = document.getElementById('settings-' + tabId);
        if (sec) {
            sec.classList.add('active');
        } else {
            console.error('Target section not found:', 'settings-' + tabId);
        }

        // Lazy Load safely
        if (tabId === 'reminders' && typeof loadReminderTemplates === 'function') loadReminderTemplates();
        if (tabId === 'forms' && typeof loadForms === 'function') loadForms();
    }
</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        loadSettings();
        loadDoctors();
    });

    async function loadSettings() {
        const res = await API.get('/api/settings');
        if (res.success) {
            if (res.location) {
                document.getElementById('officeName').value = res.location.name || '';
                document.getElementById('officeAddress').value = res.location.address || '';
                document.getElementById('officePhone').value = res.location.phone || '';
                if (document.getElementById('officeSmsName')) document.getElementById('officeSmsName').value = res.location.sms_from_name || '';
            }
            if (res.display && res.display.theme_colors) {
                const colors = res.display.theme_colors;
                document.getElementById('themePrimary').value = colors.primary || '#3b82f6';
                document.getElementById('themePrimaryText').value = colors.primary || '#3b82f6';
                document.getElementById('themeSecondary').value = colors.secondary || '#10b981';
                document.getElementById('themeSecondaryText').value = colors.secondary || '#10b981';
                document.getElementById('themeAccent').value = colors.accent || '#f59e0b';
                document.getElementById('themeAccentText').value = colors.accent || '#f59e0b';

                // Apply colors to CSS variables
                document.documentElement.style.setProperty('--color-primary', colors.primary);
                document.documentElement.style.setProperty('--color-success', colors.secondary); // Assuming secondary maps to success
                document.documentElement.style.setProperty('--color-warning', colors.accent); // Assuming accent maps to warning
            }
        }
    }

    async function loadDoctors() {
        const res = await API.get('/api/doctors');
        if (res.success) {
            const list = document.getElementById('doctorsList');
            if (res.doctors.length === 0) {
                list.innerHTML = '<p class="text-muted">No doctors found.</p>';
                return;
            }
            list.innerHTML = res.doctors.map(d => `
                <div class="card p-3 mb-2" style="border-left: 5px solid ${d.color || '#ccc'}">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <strong>${d.name}</strong> <small class="text-muted">(${d.specialty || 'General'})</small>
                            <br><small class="text-muted" style="font-size:0.8em">${d.email || ''}</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline" onclick="editDoctor(${d.id}, '${d.name}', '${d.specialty || ''}', '${d.color || ''}', '${d.email || ''}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteDoctor(${d.id})">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    }



    async function saveSettings(section) {
        let payload = { section: section };

        if (section === 'location') {
            payload.office_name = document.getElementById('officeName').value;
            payload.address = document.getElementById('officeAddress').value;
            payload.phone = document.getElementById('officePhone').value;
            payload.sms_from_name = document.getElementById('officeSmsName').value;
        } else if (section === 'display') {
            payload.theme_colors = {
                primary: document.getElementById('themePrimary').value,
                secondary: document.getElementById('themeSecondary').value,
                accent: document.getElementById('themeAccent').value
            };

            // Also update local CSS vars immediately for preview
            document.documentElement.style.setProperty('--color-primary', payload.theme_colors.primary);
            document.documentElement.style.setProperty('--color-success', payload.theme_colors.secondary);
            document.documentElement.style.setProperty('--color-warning', payload.theme_colors.accent);
            // Need to update variants too? For proper theme, yes, but for MVP just base colors.
        }

        const res = await API.put('/api/settings', payload);
        if (res.success) alert('Settings saved!');
        else alert('Error saving settings');
    }

    async function deleteDoctor(id) {
        if (!confirm('Are you sure you want to remove this doctor?')) return;

        const res = await API.delete(`/api/doctors/${id}`);
        if (res.success) {
            loadDoctors();
        } else {
            alert('Error deleting doctor: ' + res.error);
        }
    }


    <!-- Doctor Modal (Replaces Prompts) -->
    <div id="doctorModal" class="modal-overlay" style="display:none;">
        <div class="modal">
            <div class="modal-header">
                <h3 id="dm-title">Add Doctor</h3>
                <button class="close-modal" onclick="closeDoctorModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="dm-id">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="dm-name" class="form-control" placeholder="Dr. Jane Doe">
                </div>
                <div class="form-group">
                    <label>Specialty</label>
                    <input type="text" id="dm-specialty" class="form-control" placeholder="General Practice">
                </div>
                <div class="form-group">
                    <label>Email (Optional)</label>
                    <input type="email" id="dm-email" class="form-control" placeholder="dr.jane@example.com">
                </div>
                <div class="form-group">
                    <label>Color Tag</label>
                    <div class="color-swatches">
                        <div class="color-swatch" style="background:#3b82f6;" onclick="selectColor('#3b82f6', this)"></div>
                        <div class="color-swatch" style="background:#10b981;" onclick="selectColor('#10b981', this)"></div>
                        <div class="color-swatch" style="background:#f59e0b;" onclick="selectColor('#f59e0b', this)"></div>
                        <div class="color-swatch" style="background:#ef4444;" onclick="selectColor('#ef4444', this)"></div>
                        <div class="color-swatch" style="background:#8b5cf6;" onclick="selectColor('#8b5cf6', this)"></div>
                        <div class="color-swatch" style="background:#ec4899;" onclick="selectColor('#ec4899', this)"></div>
                        <div class="color-swatch" style="background:#64748b;" onclick="selectColor('#64748b', this)"></div>
                        <div class="color-swatch" style="background:#06b6d4;" onclick="selectColor('#06b6d4', this)"></div>
                    </div>
                    <input type="hidden" id="dm-color" value="#3b82f6">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDoctorModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveDoctorForm()">Save Doctor</button>
            </div>
        </div>
    </div>

    <style>
        .color-swatches {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }
        .color-swatch {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }
        .color-swatch:hover {
            transform: scale(1.1);
        }
        .color-swatch.selected {
            border-color: #1f2937;
            transform: scale(1.1);
            box-shadow: 0 0 0 2px white, 0 0 0 4px #1f2937;
        }

        /* Schedule Matrix */
        .schedule-matrix {
            display: grid;
            grid-template-columns: 150px repeat(7, 1fr);
            gap: 1px;
            background: #e5e7eb;
            border: 1px solid #e5e7eb;
            overflow-x: auto;
        }
        .matrix-header, .matrix-cell {
            background: white;
            padding: 10px;
            font-size: 0.9em;
        }
        .matrix-header {
            font-weight: 600;
            background: #f9fafb;
            text-align: center;
        }
        .matrix-row-header {
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        .matrix-cell {
            min-width: 100px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
            justify-content: center;
        }
        .time-input-xs {
            width: 100%;
            padding: 2px;
            font-size: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(14px); }
    </style>

    <script>
        // Doctor Modal Logic
        function openDoctorModal(doc=null) {
            if (doc) {
                document.getElementById('dm-title').textContent = 'Edit Doctor';
                document.getElementById('dm-id').value = doc.id;
                document.getElementById('dm-name').value = doc.name;
                document.getElementById('dm-specialty').value = doc.specialty || '';
                document.getElementById('dm-email').value = doc.email || '';
                selectColor(doc.color || '#3b82f6');
            } else {
                document.getElementById('dm-title').textContent = 'Add Doctor';
                document.getElementById('dm-id').value = '';
                document.getElementById('dm-name').value = '';
                document.getElementById('dm-specialty').value = '';
                document.getElementById('dm-email').value = '';
                selectColor('#3b82f6');
            }
            document.getElementById('doctorModal').style.display = 'flex';
        }

        function closeDoctorModal() {
            document.getElementById('doctorModal').style.display = 'none';
        }

        function selectColor(color, el=null) {
            document.getElementById('dm-color').value = color;
            document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
            
            // Find element if not passed
            if (!el) {
                el = Array.from(document.querySelectorAll('.color-swatch')).find(s => {
                    // Normalize color comparison roughly
                    return s.style.backgroundColor.includes(hexToRgb(color)) || s.getAttribute('onclick').includes(color);
                });
            }
            if (el) el.classList.add('selected');
        }

        // Helper to match computed style rgb output to hex if needed (simplified here)
        function hexToRgb(hex) {
            // Very basic check, mainly relies on finding the right div by onclick attribute in practice
            return 'rgb'; 
        }

        async function saveDoctorForm() {
            const id = document.getElementById('dm-id').value;
            const data = {
                name: document.getElementById('dm-name').value,
                specialty: document.getElementById('dm-specialty').value,
                email: document.getElementById('dm-email').value,
                color: document.getElementById('dm-color').value
            };

            if (!data.name) return alert("Name is required");

            let res;
            if (id) {
                res = await API.put(`/api/doctors/${id}`, data);
            } else {
                res = await API.post('/api/doctors', data);
            }

            if (res.success) {
                closeDoctorModal();
                loadDoctors();
                // If schedule tab is open, reload that too
                if (document.getElementById('settings-schedule').classList.contains('active')) {
                    loadScheduleMatrix();
                }
            } else {
                alert("Error: " + res.error);
            }
        }

        // Replace old edit/add functions to use new modal
        window.addDoctor = function() { openDoctorModal(); };
        window.editDoctor = function(id, name, spec, color, email) {
            openDoctorModal({ id, name, specialty: spec, color, email });
        };


        // Schedule Logic
        async function loadScheduleMatrix() {
            const container = document.getElementById('schedule-matrix-container');
            container.innerHTML = '<p class="text-center text-muted">Loading schedule...</p>';
            
            try {
                const res = await API.get('/api/schedules');
                if (!res.success) throw new Error(res.error);

                renderScheduleMatrix(res.doctors);
            } catch (e) {
                container.innerHTML = `<p class="text-danger">Error loading schedule: ${e.message}</p>`;
            }
        }

        function renderScheduleMatrix(doctors) {
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            let html = '<div class="schedule-matrix">';
            
            // Header Row
            html += '<div class="matrix-header">Doctor</div>';
            days.forEach(d => html += `<div class="matrix-header">${d}</div>`);
            
            doctors.forEach(doc => {
                html += `<div class="matrix-cell matrix-row-header" style="border-left: 4px solid ${doc.color}; padding-left:10px;">
                    <div>${doc.name}<br><small style="font-weight:normal;color:#666">${doc.specialty||''}</small></div>
                </div>`;
                
                days.forEach((day, idx) => {
                    // JS day 0 is Sunday, but our DB 0 is Monday usually. Let's standardize:
                    // Let's assume 0=Mon, 6=Sun in our DB schema comment.
                    const dayIdx = idx; 
                    
                    const sched = (doc.schedule || []).find(s => s.day_of_week === dayIdx) || {};
                    const isAvail = sched.is_available !== 0 && sched.is_available !== false; // Default true if null? No, default should be false if no record? 
                    // Actually let's default to false if no record, or true if we want to be nice.
                    // The DB default is 1, but if no row exists logic is tricky. Let's say if row exists use it.
                    
                    const start = sched.start_time || '09:00';
                    const end = sched.end_time || '17:00';
                    const checked = (sched.is_available === 1 || sched.is_available === true) ? 'checked' : '';
                    if (!sched.id) {
                         // No record implies available? Or not? Let's say not available until set.
                         // Or maybe default new docs to M-F 9-5?
                         // Let's leave unchecked if no record.
                    }

                    html += `<div class="matrix-cell">
                        <label class="toggle-switch">
                            <input type="checkbox" ${checked} onchange="updateSchedule(${doc.id}, ${dayIdx}, this.checked, '${start}', '${end}')">
                            <span class="slider"></span>
                        </label>
                        <div style="opacity: ${checked ? 1 : 0.5}; pointer-events: ${checked ? 'auto' : 'none'};">
                            <input type="time" class="time-input-xs mb-1" value="${start}" onchange="updateSchedule(${doc.id}, ${dayIdx}, true, this.value, this.nextElementSibling.value)">
                            <input type="time" class="time-input-xs" value="${end}" onchange="updateSchedule(${doc.id}, ${dayIdx}, true, this.previousElementSibling.value, this.value)">
                        </div>
                    </div>`;
                });
            });
            
            html += '</div>';
            document.getElementById('schedule-matrix-container').innerHTML = html;
        }

        async function updateSchedule(docId, dayIdx, isAvail, start, end) {
            // console.log('Updating', docId, dayIdx, isAvail, start, end);
            try {
                await API.post('/api/schedules', {
                    doctor_id: docId,
                    day_of_week: dayIdx,
                    is_available: isAvail,
                    start_time: start,
                    end_time: end
                });
                // Optional: visual feedback toast
            } catch (e) {
                console.error(e);
                alert("Failed to save schedule");
            }
        }
</script>



// Extend API helper to support DELETE
// (Assuming API helper in base.html doesn't have delete, let's just use fetch here or hope it does)
// Actually base.html API helper only has get, post, patch, put. Need to add delete or just use fetch.
// Let's patch base.html or just add it here locally if base isn't easily accessible?
// Wait, I can see base.html has get, post, patch, put. I missed delete in recent view or it wasn't there.
// I can modify base.html or just add it to the local API object enhancement if possible.
// Actually, I'll just use raw fetch for delete to avoid another base.html edit cycle unless critical.
if (!API.delete) {
API.delete = async (url) => {
const response = await fetch(url, { method: 'DELETE' });
return response.json();
};
}

// Reminder Templates Management
async function loadReminderTemplates() {
try {
const res = await API.get('/api/reminder-templates');
if (res.success) {
renderReminderTemplates(res.templates);
}
} catch (error) {
console.error('Error loading reminder templates:', error);
}
}

function formatTiming(minutes) {
if (!minutes) return '0m';
if (minutes < 60) return minutes + 'm' ; const h=Math.floor(minutes / 60); const m=minutes % 60; return h + 'h' + (m
    ? ' ' + m + 'm' : '' ); } function renderReminderTemplates(templates) { const
    container=document.getElementById('reminderTemplatesList'); if (!container) return; if (templates.length===0) {
    container.innerHTML='<p class="text-muted">No templates yet. Add one to get started.</p>' ; return; }
    container.innerHTML=templates.map(t=> `
    <div class="card p-3 mb-2" style="background: #f8fafc;">
        <div style="display:flex; justify-content:space-between; align-items:start;">
            <div>
                <strong>${t.name}</strong>
                <span class="badge"
                    style="background:#e2e8f0; color:#64748b; margin-left:8px;">${formatTiming(t.timing_minutes)}</span>
                ${t.resend_interval_minutes ? `<span class="badge"
                    style="background:#fee2e2; color:#b91c1c; margin-left:4px;">Resend:
                    ${formatTiming(t.resend_interval_minutes)}</span>` : ''}
                <p style="margin:8px 0 0; font-size:0.9em; color:#64748b; max-width:500px;">${t.message_template}</p>
            </div>
            <div style="display:flex; gap:6px;">
                <button class="btn btn-sm btn-outline" onclick='openReminderTemplateModal(${JSON.stringify(t).replace(/'
                    /g, "&#39;" )})'>Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteReminderTemplate(${t.id})">Delete</button>
            </div>
        </div>
    </div>
    `).join('');
    }

    // Global forms cache for dropdown
    let availableForms = [];

    async function refreshFormsCache() {
    try {
    const res = await API.get('/api/forms');
    if (res.success) availableForms = res.forms;
    } catch (e) { console.error(e); }
    }

    async function openReminderTemplateModal(template = null) {
    await refreshFormsCache();

    // Populate Select
    const select = document.getElementById('rt-form');
    select.innerHTML = '<option value="">-- No Form Attached --</option>' +
    availableForms.map(f => `<option value="${f.id}">${f.title}</option>`).join('');

    if (template) {
    document.getElementById('rt-modal-title').innerText = 'Edit Reminder Template';
    document.getElementById('rt-id').value = template.id;
    document.getElementById('rt-name').value = template.name;
    document.getElementById('rt-timing').value = template.timing_minutes || (template.timing_hours * 60) || 1440;
    document.getElementById('rt-resend').value = template.resend_interval_minutes || '';
    document.getElementById('rt-message').value = template.message_template;
    document.getElementById('rt-form').value = template.form_id || '';
    } else {
    document.getElementById('rt-modal-title').innerText = 'New Reminder Template';
    document.getElementById('rt-id').value = '';
    document.getElementById('rt-name').value = '';
    document.getElementById('rt-timing').value = '1440'; // Default 24h
    document.getElementById('rt-resend').value = '';
    document.getElementById('rt-message').value = 'Hi {patient_name}, this is a reminder about your appointment at
    {appointment_time}. Reply CONFIRM to confirm.';
    document.getElementById('rt-form').value = '';
    }

    // Setup Live Preview Listeners
    const msgInput = document.getElementById('rt-message');
    const formSelect = document.getElementById('rt-form');

    msgInput.oninput = updateRTPreview;
    formSelect.onchange = updateRTPreview;

    // Initial update
    updateRTPreview();

    document.getElementById('reminderTemplateModal').style.display = 'flex';
    }

    function updateRTPreview() {
    let msg = document.getElementById('rt-message').value || '';
    const formSelect = document.getElementById('rt-form');
    const formId = formSelect.value;
    const formTitle = formSelect.options[formSelect.selectedIndex] ? formSelect.options[formSelect.selectedIndex].text :
    'Form';

    // Mock replacements for visualization
    msg = msg.replace('{patient_name}', 'John Doe');
    msg = msg.replace('{appointment_time}', 'Tomorrow 10:00 AM');

    if (formId) {
    msg += `\n\nComplete forms: http://.../forms/${formId} (${formTitle})`;
    }

    // Mock Calendar Link
    if (msg.includes('{calendar_link}')) {
    msg = msg.replace('{calendar_link}', '\n[Add to Calendar Link]');
    }

    document.getElementById('rt-preview').innerText = msg;
    }

    function closeReminderTemplateModal() {
    document.getElementById('reminderTemplateModal').style.display = 'none';
    }

    async function saveReminderTemplateForm() {
    const id = document.getElementById('rt-id').value;
    const name = document.getElementById('rt-name').value;
    const timingMinutes = document.getElementById('rt-timing').value;
    const resendMinutes = document.getElementById('rt-resend').value;
    const msg = document.getElementById('rt-message').value;
    const formId = document.getElementById('rt-form').value;

    if (!name || !msg) {
    alert('Name and message are required');
    return;
    }

    const payload = {
    name: name,
    message_template: msg,
    timing_minutes: parseInt(timingMinutes) || 1440,
    resend_interval_minutes: resendMinutes ? parseInt(resendMinutes) : null,
    form_id: formId || null
    };

    try {
    let res;
    if (id) {
    res = await API.put(`/api/reminder-templates/${id}`, payload);
    } else {
    res = await API.post('/api/reminder-templates', payload);
    }

    if (res.success) {
    closeReminderTemplateModal();
    loadReminderTemplates();
    } else {
    alert('Error: ' + res.error);
    }
    } catch (e) {
    console.error(e);
    alert('Error saving template');
    }
    }

    async function deleteReminderTemplate(id) {
    if (!confirm('Delete this template?')) return;

    try {
    // Use fetch directly since API.delete might not exist
    const res = await fetch(`/api/reminder-templates/${id}`, { method: 'DELETE' });
    const data = await res.json();
    if (data.success) {
    loadReminderTemplates();
    }
    } catch (error) {
    console.error('Error deleting template:', error);
    }
    }

    function saveReminderSettings() {
    // Save auto-reminder settings (would need backend support)
    const autoEnabled = document.getElementById('autoRemindersEnabled').checked;
    const remind24hr = document.getElementById('remind24hr').checked;
    const remind2hr = document.getElementById('remind2hr').checked;

    // For now, just show confirmation
    alert('Reminder settings saved successfully!');
    }



    // Form Builder Logic
    let currentFormId = null;

    async function loadForms() {
    try {
    const res = await API.get('/api/forms');
    if (res.success) {
    renderForms(res.forms);
    }
    } catch (e) { console.error(e); }
    }

    function renderForms(forms) {
    const list = document.getElementById('formsList');
    if (forms.length === 0) {
    list.innerHTML = `
    <div style="text-align:center; padding: 40px; background:#f8fafc; border-radius:8px; border: 2px dashed #e2e8f0;">
        <div style="font-size:30px; margin-bottom:10px;">üìù</div>
        <p class="text-muted" style="margin-bottom:20px;">No patient forms created yet.</p>
        <button class="btn btn-primary" onclick="showFormBuilder()">+ Create First Form</button>
    </div>
    `;
    return;
    }
    list.innerHTML = forms.map(f => `
    <div class="card p-3 mb-2">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div><strong>${f.title}</strong><br><small class="text-muted">${f.description || ''}</small></div>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-sm btn-outline" onclick='editForm(${JSON.stringify(f).replace(/' /g, "&#39;"
                    )})'>Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteForm(${f.id})">Delete</button>
            </div>
        </div>
    </div>
    `).join('');
    }

    function showFormBuilder(form = null) {
    document.getElementById('formsList').style.display = 'none';
    document.getElementById('formBuilderUI').style.display = 'block';
    document.getElementById('fb-fields-container').innerHTML = '';

    if (form) {
    currentFormId = form.id;
    document.getElementById('fb-title').value = form.title;
    document.getElementById('fb-desc').value = form.description || '';
    (form.fields || []).forEach(field => addFormField(field));
    } else {
    currentFormId = null;
    document.getElementById('fb-title').value = '';
    document.getElementById('fb-desc').value = '';
    addFormField();
    }
    }

    function closeFormBuilder() {
    document.getElementById('formsList').style.display = 'block';
    document.getElementById('formBuilderUI').style.display = 'none';
    currentFormId = null;
    }

    function addFormField(data = {}) {
    const container = document.getElementById('fb-fields-container');
    const div = document.createElement('div');
    div.className = 'card p-3 mb-2 field-row';
    div.style.background = '#f8fafc';
    div.innerHTML = `
    <div style="display:flex; gap: 10px; align-items:center;">
        <div style="flex:2;">
            <label style="font-size:0.8em; color:#666;">Question / Label</label>
            <input type="text" class="form-control field-label" placeholder="e.g. Do you have any allergies?"
                value="${data.label || ''}">
        </div>
        <div style="flex:1;">
            <label style="font-size:0.8em; color:#666;">Type</label>
            <select class="form-control field-type">
                <option value="text" ${data.type==='text' ? 'selected' : '' }>Text Input</option>
                <option value="textarea" ${data.type==='textarea' ? 'selected' : '' }>Long Text</option>
                <option value="yesno" ${data.type==='yesno' ? 'selected' : '' }>Yes/No</option>
                <option value="signature" ${data.type==='signature' ? 'selected' : '' }>Signature</option>
                <option value="header" ${data.type==='header' ? 'selected' : '' }>Header (Section)</option>
            </select>
        </div>
        <div style="align-self: flex-end;">
            <button class="btn btn-sm btn-danger" onclick="this.closest('.field-row').remove()">X</button>
        </div>
    </div>
    `;
    container.appendChild(div);
    }

    async function saveCurrentForm() {
    const title = document.getElementById('fb-title').value;
    const description = document.getElementById('fb-desc').value;
    const fields = [];
    document.querySelectorAll('.field-row').forEach(row => {
    const label = row.querySelector('.field-label').value;
    if (label) {
    fields.push({
    label: label,
    type: row.querySelector('.field-type').value
    });
    }
    });

    if (!title) return alert('Title required');

    const payload = { id: currentFormId, title, description, fields };
    const res = await API.post('/api/forms', payload);
    if (res.success) {
    closeFormBuilder();
    loadForms();
    } else {
    alert('Error saving form');
    }
    }

    function editForm(form) {
    showFormBuilder(form);
    }

    async function deleteForm(id) {
    if (!confirm('Delete this form?')) return;
    await API.delete('/api/forms/' + id);
    loadForms();
    }
    </script>
    {% endblock %}
    ```